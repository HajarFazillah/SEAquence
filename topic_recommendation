# Talkativ: í† í”½ ì¶”ì²œ ì‹œìŠ¤í…œ

## ê°œì„  ì‚¬í•­

| ê¸°ì¡´ | ê°œì„  |
|------|------|
| ìˆ˜ë™ í‚¤ì›Œë“œ ì •ì˜ (160ê°œ) | AI-Hub ë°ì´í„° ê¸°ë°˜ í‚¤ì›Œë“œ (500+ê°œ) |
| ë‹¨ìˆœ í‚¤ì›Œë“œ ë§¤ì¹­ | TF-IDF ê°€ì¤‘ì¹˜ ì ìš© |
| 16ê°œ í† í”½ | 20ê°œ í† í”½ (AI-Hub ê¸°ì¤€) |

### ë°ì´í„° ì†ŒìŠ¤
- **AI-Hub ì£¼ì œë³„ í…ìŠ¤íŠ¸ ì¼ìƒ ëŒ€í™” ë°ì´í„°**
- URL: https://aihub.or.kr/aihubdata/data/view.do?dataSetSn=543
- ì´ 10,644ê°œ ëŒ€í™”, 20ê°œ í† í”½

## ì „ì²´ êµ¬ì¡° ìš”ì•½

**ì‚¬ìš©ìâ€“ì•„ë°”íƒ€ ëŒ€í™”**ì—ì„œ â€œì§€ê¸ˆ ìƒí™©ì— ê°€ì¥ ìì—°ìŠ¤ëŸ½ê³  ì•ˆì „í•œ ëŒ€í™” ì£¼ì œâ€ë¥¼ ê³ ë¥´ê³ , ê·¸ ì£¼ì œë¡œ ëŒ€í™” ì‹œì‘ ë¬¸ì¥(Conversation Starter)ê¹Œì§€ ìƒì„±í•˜ëŠ” **í† í”½ ì¶”ì²œ ê¸°ëŠ¥**ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ì…ë ¥(Inputs)
- **User Profile** (`PersonProfile`): ì‚¬ìš©ìì˜ ê´€ì‹¬ì‚¬/íšŒí”¼ í† í”½/ì–¸ì–´ ìˆ˜ì¤€ ë“± â€œê°œì¸í™”â€ ì •ë³´  
- **Avatar Profile** (`PersonProfile`): êµìˆ˜/ì¹œêµ¬/ë‚¯ì„  ì‚¬ëŒ ë“± â€œê´€ê³„(relationship)Â·ë§íˆ¬â€ ê²°ì •ì— í•„ìš”í•œ ì •ë³´  
- **Current Dialogue** (ë¬¸ìì—´ ë˜ëŠ” ìµœê·¼ í„´ ìš”ì•½): â€œí˜„ì¬ ëŒ€í™” íë¦„(ë§¥ë½)â€ ì •ë³´

### ì¶œë ¥(Outputs)
- **Ranked Topics**: ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ì •ë ¬ëœ ì¶”ì²œ í† í”½ ëª©ë¡  
- **Conversation Starters**: ê° í† í”½ì— ëŒ€í•´ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ì‹œì‘ ë¬¸ì¥

### 4-Layer ì¶”ì²œ íŒŒì´í”„ë¼ì¸
ì•„ë˜ íŒŒì´í”„ë¼ì¸ì€ â€œì•ˆì „ì„± â†’ ê´€ê³„ ì í•©ì„± â†’ ëŒ€í™” íë¦„â€ ìˆœìœ¼ë¡œ ì ì§„ì ìœ¼ë¡œ ì •êµí•´ì§€ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

```
Input: User Profile + Avatar Profile + Current Dialogue
                    â†“
Layer 1: Rule-Based Filtering      (ë¯¼ê°/íšŒí”¼ í† í”½ ì œê±°, ê³µí†µ ê´€ì‹¬ì‚¬ ìš°ì„ )
                    â†“
Layer 2: Relationship Scoring      (ê´€ê³„/ì§€ìœ„/ì¹œë°€ë„ ê¸°ë°˜ ì í•©ì„± ì ìˆ˜)
                    â†“
Layer 3: Context-Aware Ranking     (í˜„ì¬ ëŒ€í™” í† í”½/ì „í™˜ ìì—°ìŠ¤ëŸ¬ì›€ ë°˜ì˜)
                    â†“
Layer 4: Starter Generation        (í…œí”Œë¦¿ ìš°ì„  + ì„ íƒì  LLM + ìºì‹œ)
                    â†“
Output: Ranked Topics + Conversation Starters
```

## ì¤‘ìš”í•œ ì„¤ê³„ ì² í•™
1) **í•„í„°ë§ì„ ë¨¼ì €** í•´ì„œ â€œì¶”ì²œí•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒâ€ì„ ì œê±°  
2) ê·¸ ë‹¤ìŒ â€œê´€ê³„ì— ë§ëŠ”ê°€?â€ë¥¼ í‰ê°€  
3) ë§ˆì§€ë§‰ì— â€œì§€ê¸ˆ íë¦„ì—ì„œ ìì—°ìŠ¤ëŸ¬ìš´ê°€?â€ë¥¼ ë°˜ì˜  
4) ì‹œì‘ ë¬¸ì¥ì€ **í…œí”Œë¦¿ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´** í›„, í•„ìš”í•  ë•Œë§Œ LLMì„ ì‚¬ìš©í•˜ì—¬ ë¹„ìš©/ë¶ˆì•ˆì •ì„±ì„ ì¤„ì…ë‹ˆë‹¤.


---
## 1. í™˜ê²½ ì„¤ì •

### 1-1. í™˜ê²½ ì„¤ì • ì½”ë“œ ì„¤ëª… (Imports & Mode)

ì´ ì„¹ì…˜ì˜ ì½”ë“œëŠ” ë…¸íŠ¸ë¶ ì „ì²´ì—ì„œ ì“°ì´ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ì‹¤í–‰ ëª¨ë“œë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.

####  ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—­í• 
- `re, math` : í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬(ì •ê·œì‹), ì ìˆ˜ ê³„ì‚°
- `dataclasses` : `PersonProfile`, `TopicRecommendation` ê°™ì€ êµ¬ì¡°ì²´ë¥¼ ê°„ê²°í•˜ê²Œ ì •ì˜
- `collections.Counter` : í‚¤ì›Œë“œ ë¹ˆë„ ê³„ì‚°(í† í”½ íƒì§€ ì ìˆ˜ì— ì‚¬ìš©)
- `ipywidgets` (ì„ íƒ) : ë°ëª¨ í™˜ê²½ì—ì„œ ëª¨ë“œ/íŒŒë¼ë¯¸í„°ë¥¼ í† ê¸€í•  ë•Œ ì‚¬ìš© ê°€ëŠ¥

####  `USE_LLM` í”Œë˜ê·¸ì˜ ì˜ë¯¸
- `USE_LLM = False` : **ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ**  
  - í† í”½ ì¶”ì²œê³¼ ë¬¸ì¥ ìƒì„±ì´ *ì™„ì „íˆ ê·œì¹™/í…œí”Œë¦¿ ê¸°ë°˜*ìœ¼ë¡œ ë™ì‘
  - ë°ëª¨ ì•ˆì •ì„± ë†’ê³  ë¹„ìš© 0
- `USE_LLM = True` : **LLM ëª¨ë“œ(í™•ì¥ ê°€ëŠ¥)**  
  - Layer 4ì—ì„œ â€œìƒìœ„ Nê°œ í† í”½â€ë§Œ LLMë¡œ ë” ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ë“¬ëŠ” ë°©ì‹ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥
  - ì´ ë…¸íŠ¸ë¶ì€ **LLM í˜¸ì¶œë¶€ë¥¼ â€˜í›„í‚¹(hook)â€™ í˜•íƒœ**ë¡œ ë‘¬ì„œ ë‚˜ì¤‘ì— APIë¥¼ ì—°ê²°í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.


import os
import re
import json
import math
import requests
import random
from typing import List, Dict, Set, Tuple, Optional
from dataclasses import dataclass, field
from collections import Counter, defaultdict
from enum import Enum

print(" ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ")

# ëª¨ë“œ ì„¤ì •
USE_LLM = False

try:
    import ipywidgets as widgets
    from IPython.display import display

    mode_toggle = widgets.ToggleButtons(
        options=[("ğŸ”§ Simulation", False), (" LLM (CLOVA Studio)", True)],
        value=USE_LLM,
        description="Mode:"
    )

    def on_mode_change(change):
        global USE_LLM
        USE_LLM = change['new']
        print(f"ëª¨ë“œ: {'LLM' if USE_LLM else 'Simulation'}")

    mode_toggle.observe(on_mode_change, names='value')
    display(mode_toggle)
except:
    pass

print(f"í˜„ì¬ ëª¨ë“œ: {'LLM' if USE_LLM else 'Simulation'}")

---
## 2. AI-Hub ë°ì´í„° ê¸°ë°˜ í† í”½ ë¶„ë¥˜ ì²´ê³„

AI-Hub ë°ì´í„°ì—ì„œ ì¶”ì¶œí•œ ì‹¤ì œ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 2-1. AI-Hub í† í”½ ì²´ê³„ ë°ì´í„° êµ¬ì¡° ì„¤ëª…

ì´ ì„¹ì…˜ì€ AI-Hubì˜ â€œ20ê°œ í† í”½â€ì„ ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ **ì •ê·œí™”ëœ í† í”½ ì‚¬ì „**ì…ë‹ˆë‹¤.  
(**ë°ì´í„°ì…‹ì˜ ë¼ë²¨ ì²´ê³„ë¥¼ ê·¸ëŒ€ë¡œ ë°˜ì˜**)

#### `AI_HUB_TOPICS`ì— ë“¤ì–´ìˆëŠ” ì •ë³´(ì˜ˆì‹œ)
ê° í† í”½ì€ ë³´í†µ ì•„ë˜ í•„ë“œë¥¼ ê°€ì§‘ë‹ˆë‹¤.
- `name_ko` / `name_en` : í† í”½ì˜ í•œ/ì˜ ì´ë¦„
- `keywords` : í•´ë‹¹ í† í”½ì„ ëŒ€í‘œí•˜ëŠ” í‚¤ì›Œë“œ ëª©ë¡ (AI-Hub ëŒ€í™”ì—ì„œ ì¶”ì¶œ/ì •ë¦¬)
- (ì¶”ê°€ ê°€ëŠ¥) `sensitive` / `avoid` ê°™ì€ í”Œë˜ê·¸: ì•ˆì „ í•„í„°ë§ì— í™œìš©

#### ì™œ â€œí‚¤ì›Œë“œ ì‚¬ì „â€ì´ í•„ìš”í•œê°€?
Layer 3(ë§¥ë½ ê¸°ë°˜ ë­í‚¹)ì—ì„œ **í˜„ì¬ ëŒ€í™”ê°€ ì–´ë–¤ í† í”½ì„ ë‹¤ë£¨ëŠ”ì§€ íƒì§€**í•´ì•¼ í•©ë‹ˆë‹¤.  
ì´ë¥¼ ìœ„í•´ â€œëŒ€í™” í…ìŠ¤íŠ¸ â†” í† í”½ í‚¤ì›Œë“œâ€ì˜ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.

#### í™•ì¥ í¬ì¸íŠ¸
- í† í”½ì„ ì¶”ê°€í•˜ë ¤ë©´:
  1) `AI_HUB_TOPICS`ì— ìƒˆ í† í”½ í•­ëª© ì¶”ê°€  
  2) `STARTER_TEMPLATES`ì— í•´ë‹¹ í† í”½ ì‹œì‘ ë¬¸ì¥ í…œí”Œë¦¿ ì¶”ê°€  
  3) (ì„ íƒ) ì „í™˜ ê·¸ë˜í”„ì— ìì—°ìŠ¤ëŸ¬ìš´ ë‹¤ìŒ í† í”½ ì—°ê²° ì¶”ê°€


# ============================================================
# AI-Hub ê¸°ë°˜ í† í”½ ë¶„ë¥˜ ì²´ê³„ (20ê°œ í† í”½)
# í‚¤ì›Œë“œëŠ” ì‹¤ì œ ëŒ€í™” ë°ì´í„°ì—ì„œ ì¶”ì¶œ
# ============================================================

TOPIC_TAXONOMY = {
    # ========== ê°€ì¡±/ê´€ê³„ ==========
    "ê°€ì¡±": {
        "name_ko": "ê°€ì¡±",
        "name_en": "Family",
        "category": "relationship",
        "keywords": [
            "ì—„ë§ˆ", "ì•„ë¹ ", "ë¶€ëª¨ë‹˜", "ë™ìƒ", "ì–¸ë‹ˆ", "ì˜¤ë¹ ", "ëˆ„ë‚˜", "í˜•",
            "ê°€ì¡±", "ê°€ì¡±ë“¤", "ì–´ë¨¸ë‹ˆ", "ì•„ë²„ì§€", "í• ë¨¸ë‹ˆ", "í• ì•„ë²„ì§€",
            "ì¡°ì¹´", "ì‚¼ì´Œ", "ì´ëª¨", "ê³ ëª¨", "ì™¸ì‚¼ì´Œ", "ì‚¬ì´Œ",
            "ì§‘ì•ˆ", "ëª…ì ˆ", "ì¶”ì„", "ì„¤ë‚ ", "ì œì‚¬", "ê°€ì¡±ì—¬í–‰"
        ],
        "weight": {"ì—„ë§ˆ": 2.0, "ì•„ë¹ ": 2.0, "ê°€ì¡±": 2.5, "ë¶€ëª¨ë‹˜": 2.0},
        "formality_min": "polite",
        "is_sensitive": False
    },

    "ì—°ì• /ê²°í˜¼": {
        "name_ko": "ì—°ì• /ê²°í˜¼",
        "name_en": "Dating & Marriage",
        "category": "relationship",
        "keywords": [
            "ê²°í˜¼", "ì—°ì• ", "ë‚¨ìì¹œêµ¬", "ì—¬ìì¹œêµ¬", "ë‚¨í¸", "ì™€ì´í”„", "ì•„ë‚´",
            "ê²°í˜¼ì‹", "ì‹ í˜¼", "ì˜ˆë¹„ì‹ ë¶€", "ì˜ˆë¹„ì‹ ë‘", "ì²­ì²©ì¥",
            "ê¸°ë…ì¼", "ë°ì´íŠ¸", "ì†Œê°œíŒ…", "ì„ ë¬¼", "ì»¤í”Œ",
            "ì‚¬ê·€ë‹¤", "í—¤ì–´ì§€ë‹¤", "ì´ë³„", "ê³ ë°±", "í”„ë¡œí¬ì¦ˆ", "ìœ¡ì•„"
        ],
        "weight": {"ê²°í˜¼": 2.5, "ì—°ì• ": 2.5, "ë‚¨ìì¹œêµ¬": 2.0, "ì—¬ìì¹œêµ¬": 2.0},
        "formality_min": "informal",
        "is_sensitive": True
    },

    # ========== ì¼/í•™ì—… ==========
    "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸": {
        "name_ko": "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸",
        "name_en": "Work & Part-time Job",
        "category": "work",
        "keywords": [
            "íšŒì‚¬", "ì•Œë°”", "ì•„ë¥´ë°”ì´íŠ¸", "ì§ì¥", "ì·¨ì—…", "ì´ì§",
            "ì¶œê·¼", "í‡´ê·¼", "ì•¼ê·¼", "íšŒì‹", "ì—…ë¬´", "ì›”ê¸‰", "ì‹œê¸‰",
            "ìƒì‚¬", "íŒ€ì¥", "ë¶€ì¥", "ì‚¬ì¥", "ë™ë£Œ", "ì¸í„´",
            "ë©´ì ‘", "ì´ë ¥ì„œ", "ìì†Œì„œ", "í‡´ì‚¬", "íœ´ê°€"
        ],
        "weight": {"íšŒì‚¬": 2.5, "ì•Œë°”": 2.5, "ì·¨ì—…": 2.0, "íšŒì‹": 1.5},
        "formality_min": "polite",
        "is_sensitive": False
    },

    "êµìœ¡": {
        "name_ko": "êµìœ¡",
        "name_en": "Education",
        "category": "academic",
        "keywords": [
            "ê³µë¶€", "í•™ì›", "í•™êµ", "ìˆ˜ì—…", "ì‹œí—˜", "ì„ ìƒë‹˜", "êµìˆ˜ë‹˜",
            "ì˜ì–´", "ìˆ˜í•™", "ê³¼í•™", "êµ­ì–´", "í† ìµ", "í† í”Œ",
            "ìê²©ì¦", "ìˆ˜ëŠ¥", "ëŒ€í•™", "ì…ì‹œ", "ê³¼ì™¸",
            "ì„±ì ", "í•™ì ", "ì¤‘ê°„ê³ ì‚¬", "ê¸°ë§ê³ ì‚¬", "ë ˆí¬íŠ¸", "ê³¼ì œ",
            "ë™ì•„ë¦¬", "MT", "OT", "ìˆ˜ê°•ì‹ ì²­", "ì¡¸ì—…"
        ],
        "weight": {"ê³µë¶€": 2.0, "í•™ì›": 2.0, "ì‹œí—˜": 2.0, "í•™êµ": 1.5},
        "formality_min": "polite",
        "is_sensitive": False
    },

    "êµ°ëŒ€": {
        "name_ko": "êµ°ëŒ€",
        "name_en": "Military",
        "category": "life",
        "keywords": [
            "êµ°ëŒ€", "êµ°ì¸", "í›ˆë ¨", "íœ´ê°€", "ì „ì—­", "ì…ëŒ€", "ë³µë¬´",
            "ìœ¡êµ°", "í•´êµ°", "ê³µêµ°", "í•´ë³‘ëŒ€", "ë¶€ëŒ€", "ë³´ì§",
            "ì´ë“±ë³‘", "ì¼ë³‘", "ìƒë³‘", "ë³‘ì¥", "ì¥êµ", "ë¶€ì‚¬ê´€",
            "í›ˆë ¨ì†Œ", "ìëŒ€", "êµ°ìƒí™œ", "ë©´íšŒ", "êµ°ë³µ"
        ],
        "weight": {"êµ°ëŒ€": 3.0, "êµ°ì¸": 2.0, "ì „ì—­": 2.0, "íœ´ê°€": 1.5},
        "formality_min": "polite",
        "is_sensitive": False
    },

    # ========== ì¼ìƒìƒí™œ ==========
    "ì£¼ê±°ì™€ìƒí™œ": {
        "name_ko": "ì£¼ê±°ì™€ìƒí™œ",
        "name_en": "Housing & Living",
        "category": "daily",
        "keywords": [
            "ì•„íŒŒíŠ¸", "ì£¼íƒ", "ë¹Œë¼", "ì˜¤í”¼ìŠ¤í…”", "ì›ë£¸",
            "ì „ì„¸", "ì›”ì„¸", "ì§‘ê°’", "ë¶€ë™ì‚°", "ë§¤ë§¤", "ì²­ì•½", "ëŒ€ì¶œ",
            "ì´ì‚¬", "ì¸í…Œë¦¬ì–´", "ë¦¬ëª¨ë¸ë§", "ìì·¨", "ë™ë„¤",
            "ì²­ì†Œ", "ë¹¨ë˜", "ê°€êµ¬", "ê°€ì „", "ëƒ‰ì¥ê³ ", "ì„¸íƒê¸°"
        ],
        "weight": {"ì•„íŒŒíŠ¸": 2.0, "ì „ì„¸": 2.0, "ì›”ì„¸": 2.0, "ì´ì‚¬": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "êµí†µ": {
        "name_ko": "êµí†µ",
        "name_en": "Transportation",
        "category": "daily",
        "keywords": [
            "ë²„ìŠ¤", "ì§€í•˜ì² ", "íƒì‹œ", "ê¸°ì°¨", "KTX", "ë¹„í–‰ê¸°",
            "ìš´ì „", "ë©´í—ˆ", "ìë™ì°¨", "ì°¨", "ì „ê¸°ì°¨", "í…ŒìŠ¬ë¼",
            "ëŒ€ì¤‘êµí†µ", "ì¶œí‡´ê·¼", "ì£¼ì°¨", "ì£¼ì°¨ì¥",
            "ì‚¬ê³ ", "êµí†µì‚¬ê³ ", "ì‹ í˜¸ë“±", "ë„ë¡œ", "ê³ ì†ë„ë¡œ",
            "ìì „ê±°", "í‚¥ë³´ë“œ", "ì˜¤í† ë°”ì´"
        ],
        "weight": {"ë²„ìŠ¤": 2.0, "ì§€í•˜ì² ": 2.0, "ìš´ì „": 1.5, "êµí†µ": 2.0},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ê±´ê°•": {
        "name_ko": "ê±´ê°•",
        "name_en": "Health",
        "category": "daily",
        "keywords": [
            "ê±´ê°•", "ìš´ë™", "ë³‘ì›", "ì˜ì‚¬", "ì•½", "ì¹˜ë£Œ", "ìˆ˜ìˆ ",
            "ë‹¤ì´ì–´íŠ¸", "ì‚´", "ì²´ì¤‘", "í—¬ìŠ¤", "PT",
            "í—ˆë¦¬", "ëª©", "ì–´ê¹¨", "ë‘í†µ", "ê°ê¸°", "ì—´",
            "ì˜ì–‘ì œ", "ë¹„íƒ€ë¯¼", "ë³´í—˜", "ê±´ê°•ê²€ì§„",
            "ì •ì‹ ê±´ê°•", "ìŠ¤íŠ¸ë ˆìŠ¤", "ìš°ìš¸", "ë¶ˆë©´ì¦"
        ],
        "weight": {"ê±´ê°•": 2.5, "ë³‘ì›": 2.0, "ìš´ë™": 1.5, "ë‹¤ì´ì–´íŠ¸": 1.5},
        "formality_min": "polite",
        "is_sensitive": False
    },

    "ë¯¸ìš©": {
        "name_ko": "ë¯¸ìš©",
        "name_en": "Beauty",
        "category": "daily",
        "keywords": [
            "ë¨¸ë¦¬", "í—¤ì–´", "ë¯¸ìš©ì‹¤", "ì—¼ìƒ‰", "íŒŒë§ˆ", "ì»¤íŠ¸",
            "í”¼ë¶€", "í”¼ë¶€ê³¼", "ì—¬ë“œë¦„", "ì¡í‹°", "ì£¼ë¦„",
            "í™”ì¥", "ë©”ì´í¬ì—…", "í™”ì¥í’ˆ", "ìŠ¤í‚¨ì¼€ì–´",
            "ëˆˆì¹", "ì†ëˆˆì¹", "ë„¤ì¼", "íƒˆëª¨", "ë‘í”¼",
            "ì„±í˜•", "ì‹œìˆ ", "ë ˆì´ì €", "í•„ëŸ¬", "ë³´í†¡ìŠ¤"
        ],
        "weight": {"ë¨¸ë¦¬": 1.5, "í”¼ë¶€": 2.0, "ë¯¸ìš©ì‹¤": 2.0, "í™”ì¥": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ê³„ì ˆ/ë‚ ì”¨": {
        "name_ko": "ê³„ì ˆ/ë‚ ì”¨",
        "name_en": "Weather & Season",
        "category": "daily",
        "keywords": [
            "ë‚ ì”¨", "ì˜¤ëŠ˜ë‚ ì”¨", "ë¹„", "ëˆˆ", "ìš°ì‚°", "íƒœí’", "ì¥ë§ˆ",
            "ë´„", "ì—¬ë¦„", "ê°€ì„", "ê²¨ìš¸", "ê³„ì ˆ",
            "ë”ì›Œ", "ì¶”ì›Œ", "ë¥ë‹¤", "ì¶¥ë‹¤", "ì‹œì›", "ë”°ëœ»",
            "ì—ì–´ì»¨", "ë‚œë°©", "íˆí„°", "ì„ í’ê¸°",
            "ë‹¨í’", "ë²šê½ƒ", "ëˆˆì‚¬ëŒ", "íŒ¨ë”©", "ë°˜íŒ”"
        ],
        "weight": {"ë‚ ì”¨": 3.0, "ê²¨ìš¸": 2.0, "ì—¬ë¦„": 2.0, "ë¹„": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    # ========== ìŒì‹/ì‡¼í•‘ ==========
    "ì‹ìŒë£Œ": {
        "name_ko": "ì‹ìŒë£Œ",
        "name_en": "Food & Drink",
        "category": "culture",
        "keywords": [
            "ë°¥", "ì ì‹¬", "ì €ë…", "ì•„ì¹¨", "ì‹ì‚¬", "ë§›ì§‘",
            "ì»¤í”¼", "ì¹´í˜", "ë””ì €íŠ¸", "ì¼€ì´í¬", "ë¹µ",
            "ì¹˜í‚¨", "í”¼ì", "í–„ë²„ê±°", "ë¼ë©´", "ë–¡ë³¶ì´", "ì‚¼ê²¹ì‚´",
            "ë°°ë‹¬", "ë°°ë‹¬ìŒì‹", "ì•¼ì‹", "ìˆ ", "ë§¥ì£¼", "ì†Œì£¼",
            "ìš”ë¦¬", "ë ˆì‹œí”¼", "ë©”ë‰´", "ìŒì‹", "ìŒë£Œ"
        ],
        "weight": {"ë§›ì§‘": 2.0, "ì»¤í”¼": 1.5, "ë°°ë‹¬": 1.5, "ì¹˜í‚¨": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ìƒê±°ë˜ì „ë°˜": {
        "name_ko": "ì‡¼í•‘/ìƒê±°ë˜",
        "name_en": "Shopping & Commerce",
        "category": "daily",
        "keywords": [
            "ì‡¼í•‘", "ì‡¼í•‘ëª°", "ì˜¨ë¼ì¸ì‡¼í•‘", "ì¸í„°ë„·ì‡¼í•‘",
            "ì¿ íŒ¡", "ë„¤ì´ë²„ì‡¼í•‘", "11ë²ˆê°€", "ìœ„ë©”í”„", "í‹°ëª¬",
            "í• ì¸", "ì„¸ì¼", "ì¿ í°", "ì ë¦½ê¸ˆ", "ì¹´ë“œ",
            "ë°°ì†¡", "íƒë°°", "ë°˜í’ˆ", "êµí™˜", "í™˜ë¶ˆ",
            "êµ¬ë§¤", "ì£¼ë¬¸", "ê²°ì œ", "ê°€ê²©", "ë‹¹ê·¼ë§ˆì¼“", "ì¤‘ê³ "
        ],
        "weight": {"ì‡¼í•‘": 2.0, "ì¿ íŒ¡": 2.0, "í• ì¸": 1.5, "ë°°ì†¡": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    # ========== ì·¨ë¯¸/ì—”í„°í…Œì¸ë¨¼íŠ¸ ==========
    "ê²Œì„": {
        "name_ko": "ê²Œì„",
        "name_en": "Gaming",
        "category": "entertainment",
        "keywords": [
            "ê²Œì„", "ë¡¤", "LOL", "ë°°ê·¸", "ì˜¤ë²„ì›Œì¹˜", "í”¼íŒŒ",
            "ë‹Œí…ë„", "ìŠ¤ìœ„ì¹˜", "í”ŒìŠ¤", "í”Œë ˆì´ìŠ¤í…Œì´ì…˜", "ì—‘ìŠ¤ë°•ìŠ¤",
            "ëª¨ë°”ì¼ê²Œì„", "PCê²Œì„", "ì˜¨ë¼ì¸ê²Œì„",
            "ìºë¦­í„°", "ë ˆë²¨", "ì•„ì´í…œ", "í˜„ì§ˆ", "ê³¼ê¸ˆ",
            "ìŠ¤íŒ€", "eìŠ¤í¬ì¸ ", "í”„ë¡œê²Œì´ë¨¸", "ì˜¤ë½ì‹¤"
        ],
        "weight": {"ê²Œì„": 3.0, "ë¡¤": 2.0, "ë‹Œí…ë„": 2.0, "ë°°ê·¸": 2.0},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ìŠ¤í¬ì¸ /ë ˆì €": {
        "name_ko": "ìŠ¤í¬ì¸ /ë ˆì €",
        "name_en": "Sports & Leisure",
        "category": "entertainment",
        "keywords": [
            "ìš´ë™", "ì¶•êµ¬", "ì•¼êµ¬", "ë†êµ¬", "ë°°êµ¬", "í…Œë‹ˆìŠ¤", "ê³¨í”„",
            "í—¬ìŠ¤", "ìˆ˜ì˜", "ë“±ì‚°", "ìì „ê±°", "ëŸ¬ë‹", "ë§ˆë¼í†¤",
            "ìº í•‘", "ë‚šì‹œ", "ë³¼ë§", "ë‹¹êµ¬", "íƒêµ¬",
            "ì˜¬ë¦¼í”½", "ì›”ë“œì»µ", "ê²½ê¸°", "ì„ ìˆ˜", "íŒ€",
            "ìŠ¤í‚¤", "ìŠ¤ë…¸ë³´ë“œ", "ì„œí•‘", "ìš”ê°€", "í•„ë¼í…ŒìŠ¤"
        ],
        "weight": {"ì¶•êµ¬": 2.0, "ì•¼êµ¬": 2.0, "ìº í•‘": 2.0, "ë“±ì‚°": 2.0},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ë°©ì†¡/ì—°ì˜ˆ": {
        "name_ko": "ë°©ì†¡/ì—°ì˜ˆ",
        "name_en": "Broadcasting & Entertainment",
        "category": "entertainment",
        "keywords": [
            "ë“œë¼ë§ˆ", "ì˜ˆëŠ¥", "ë°©ì†¡", "TV", "í‹°ë¹„",
            "ìœ íŠœë¸Œ", "ìœ íŠœë²„", "ì¸í”Œë£¨ì–¸ì„œ", "ìŠ¤íŠ¸ë¦¬ë¨¸",
            "ì•„ì´ëŒ", "ê°€ìˆ˜", "ì—°ì˜ˆì¸", "ë°°ìš°", "ê°œê·¸ë§¨",
            "ë…¸ë˜", "ìŒì•…", "ì•¨ë²”", "ì½˜ì„œíŠ¸", "íŒ¬ë¯¸íŒ…",
            "BTS", "ë¸”ë™í•‘í¬", "íˆ¬ë°”íˆ¬", "ì•„ì´ë¸Œ"
        ],
        "weight": {"ë“œë¼ë§ˆ": 2.0, "ì˜ˆëŠ¥": 2.0, "ì•„ì´ëŒ": 2.0, "ìœ íŠœë¸Œ": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ì˜í™”/ë§Œí™”": {
        "name_ko": "ì˜í™”/ë§Œí™”",
        "name_en": "Movies & Comics",
        "category": "entertainment",
        "keywords": [
            "ì˜í™”", "ì˜í™”ê´€", "CGV", "ë©”ê°€ë°•ìŠ¤", "ë¡¯ë°ì‹œë„¤ë§ˆ",
            "ë„·í”Œë¦­ìŠ¤", "ì™“ì± ", "ë””ì¦ˆë‹ˆí”ŒëŸ¬ìŠ¤", "ì›¨ì´ë¸Œ",
            "ë§Œí™”", "ì›¹íˆ°", "ì• ë‹ˆë©”ì´ì…˜", "ì• ë‹ˆ",
            "ë§ˆë¸”", "DC", "ë””ì¦ˆë‹ˆ", "í”½ì‚¬", "ì§€ë¸Œë¦¬",
            "ê°ë…", "ë°°ìš°", "ê°œë´‰", "ì‹œì‚¬íšŒ", "ìŠ¤í¬ì¼ëŸ¬"
        ],
        "weight": {"ì˜í™”": 3.0, "ë„·í”Œë¦­ìŠ¤": 2.0, "ì›¹íˆ°": 2.0, "ë§Œí™”": 2.0},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ì—¬í–‰": {
        "name_ko": "ì—¬í–‰",
        "name_en": "Travel",
        "category": "entertainment",
        "keywords": [
            "ì—¬í–‰", "í•´ì™¸ì—¬í–‰", "êµ­ë‚´ì—¬í–‰", "íœ´ê°€",
            "ì œì£¼ë„", "ë¶€ì‚°", "ê°•ë¦‰", "ê²½ì£¼", "ì†ì´ˆ", "ì „ì£¼",
            "ì¼ë³¸", "íƒœêµ­", "ë² íŠ¸ë‚¨", "ìœ ëŸ½", "ë¯¸êµ­",
            "í˜¸í…”", "ìˆ™ì†Œ", "ì—ì–´ë¹„ì•¤ë¹„", "íœì…˜", "ë¦¬ì¡°íŠ¸",
            "ë¹„í–‰ê¸°", "ê³µí•­", "ì—¬ê¶Œ", "ë¹„ì", "í™˜ì „"
        ],
        "weight": {"ì—¬í–‰": 3.0, "ì œì£¼ë„": 2.0, "í•´ì™¸ì—¬í–‰": 2.0, "í˜¸í…”": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    "ë°˜ë ¤ë™ë¬¼": {
        "name_ko": "ë°˜ë ¤ë™ë¬¼",
        "name_en": "Pets",
        "category": "daily",
        "keywords": [
            "ê°•ì•„ì§€", "ê³ ì–‘ì´", "ë°˜ë ¤ë™ë¬¼", "í«", "ì• ì™„ë™ë¬¼",
            "ì‚°ì±…", "ê°„ì‹", "ì‚¬ë£Œ", "ëª©ì¤„", "ë°°ë³€íŒ¨ë“œ",
            "í–„ìŠ¤í„°", "í† ë¼", "ë¬¼ê³ ê¸°", "ê±°ë¶ì´", "ì•µë¬´ìƒˆ",
            "ë™ë¬¼ë³‘ì›", "ì˜ˆë°©ì ‘ì¢…", "ì¤‘ì„±í™”", "ì…ì–‘", "ë¶„ì–‘"
        ],
        "weight": {"ê°•ì•„ì§€": 3.0, "ê³ ì–‘ì´": 3.0, "ë°˜ë ¤ë™ë¬¼": 2.5, "ì‚°ì±…": 1.5},
        "formality_min": "informal",
        "is_sensitive": False
    },

    # ========== ë¯¼ê° í† í”½ ==========
    "ì‚¬íšŒì´ìŠˆ": {
        "name_ko": "ì‚¬íšŒì´ìŠˆ",
        "name_en": "Social Issues",
        "category": "sensitive",
        "keywords": [
            "ë‰´ìŠ¤", "ì‚¬ê±´", "ì‚¬ê³ ", "ì´ìŠˆ", "ê¸°ì‚¬",
            "ì½”ë¡œë‚˜", "ë°±ì‹ ", "ë§ˆìŠ¤í¬", "í™•ì§„ì", "ê±°ë¦¬ë‘ê¸°",
            "ë²”ì£„", "ì‚¬ê¸°", "í”¼í•´", "ê²½ì°°", "ê²€ì°°",
            "ì •ì¹˜", "ì„ ê±°", "ëŒ€í†µë ¹", "êµ­íšŒ", "ì •ë‹¹",
            "ì£¼ì‹", "ë¶€ë™ì‚°", "ë¬¼ê°€", "ê²½ì œ"
        ],
        "weight": {"ë‰´ìŠ¤": 1.5, "ì½”ë¡œë‚˜": 2.0, "ì‚¬ê±´": 1.5},
        "formality_min": "polite",
        "is_sensitive": True
    },

    "íƒ€êµ­ê°€ì´ìŠˆ": {
        "name_ko": "íƒ€êµ­ê°€ì´ìŠˆ",
        "name_en": "International Issues",
        "category": "sensitive",
        "keywords": [
            "ë¯¸êµ­", "ì¤‘êµ­", "ì¼ë³¸", "ë¶í•œ", "ëŸ¬ì‹œì•„",
            "ìš°ë¦¬ë‚˜ë¼", "ì™¸êµ­", "í•´ì™¸", "êµ­ì œ",
            "ì „ìŸ", "ë¶„ìŸ", "ì™¸êµ", "ë¬´ì—­",
            "ì˜¬ë¦¼í”½", "ì›”ë“œì»µ"
        ],
        "weight": {"ë¯¸êµ­": 1.5, "ì¤‘êµ­": 1.5, "ì¼ë³¸": 1.5},
        "formality_min": "polite",
        "is_sensitive": True
    }
}

# ë¯¼ê° í† í”½ ëª©ë¡
SENSITIVE_TOPICS = [tid for tid, data in TOPIC_TAXONOMY.items()
                    if data.get("is_sensitive", False)]

print(f" í† í”½ ë¶„ë¥˜ ì²´ê³„ ì •ì˜ ì™„ë£Œ")
print(f"   - ì´ {len(TOPIC_TAXONOMY)}ê°œ í† í”½")
print(f"   - ë¯¼ê° í† í”½: {SENSITIVE_TOPICS}")
print(f"   - ì´ í‚¤ì›Œë“œ ìˆ˜: {sum(len(t['keywords']) for t in TOPIC_TAXONOMY.values())}ê°œ")

---
## 3. ê°œì„ ëœ í† í”½ íƒì§€ê¸° (TF-IDF ê°€ì¤‘ì¹˜)

### 3-1. ê°œì„ ëœ í† í”½ íƒì§€ê¸°(ImprovedTopicDetector) ìƒì„¸ ì„¤ëª…

ì´ ì„¹ì…˜ì€ â€œí˜„ì¬ ëŒ€í™”ì—ì„œ ì–´ë–¤ í† í”½ì´ ë“±ì¥í–ˆëŠ”ì§€â€ë¥¼ **ì ìˆ˜í™”**í•©ë‹ˆë‹¤.  
ë‹¨ìˆœíˆ â€œí‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ í•´ë‹¹ í† í”½â€ì´ ì•„ë‹ˆë¼, **ì¤‘ìš” í‚¤ì›Œë“œëŠ” ë” í¬ê²Œ ë°˜ì˜**í•˜ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

#### ì…ë ¥/ì¶œë ¥
- ì…ë ¥: `text: str` (ìµœê·¼ ëŒ€í™” í…ìŠ¤íŠ¸)
- ì¶œë ¥: `List[str]` (ì ìˆ˜ê°€ ë†’ì€ í† í”½ ì´ë¦„ ëª©ë¡)

#### í•µì‹¬ ì•„ì´ë””ì–´: TF-IDF ê°€ì¤‘ì¹˜(ê°€ë²¼ìš´ ë²„ì „)
- ì–´ë–¤ ë‹¨ì–´ëŠ” ì–´ëŠ í† í”½ì—ì„œë„ í”íˆ ë“±ì¥í•©ë‹ˆë‹¤. (ì˜ˆ: â€œì¢‹ë‹¤â€, â€œìš”ì¦˜â€)
- ì–´ë–¤ ë‹¨ì–´ëŠ” íŠ¹ì • í† í”½ì—ì„œë§Œ ê°•í•˜ê²Œ ë“±ì¥í•©ë‹ˆë‹¤. (ì˜ˆ: â€œì‹œí—˜â€, â€œë©´ì ‘â€, â€œìš´ë™â€)
- ê·¸ë˜ì„œ **í‚¤ì›Œë“œë³„ ì¤‘ìš”ë„(weight)** ë¥¼ ì£¼ê³ , ë‹¨ìˆœ ë¹ˆë„ë³´ë‹¤ â€œêµ¬ë¶„ë ¥ ìˆëŠ” ë‹¨ì–´â€ë¥¼ ë” ì‹ ë¢°í•©ë‹ˆë‹¤.

#### ì ìˆ˜ ê³„ì‚° íë¦„(ê°œë…)
1) í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬: ì†Œë¬¸ìí™”/ê¸°í˜¸ ì œê±° ë“±
2) ë‹¨ì–´ ë¹ˆë„ ê³„ì‚°: `Counter`
3) í† í”½ë³„ ì ìˆ˜ í•©ì‚°:
   - â€œí† í”½ í‚¤ì›Œë“œê°€ í…ìŠ¤íŠ¸ì— ë‚˜íƒ€ë‚¬ëŠ”ê°€?â€
   - ë‚˜íƒ€ë‚¬ë‹¤ë©´ ê·¸ í‚¤ì›Œë“œì˜ ì¤‘ìš”ë„(ê°€ì¤‘ì¹˜)ë¥¼ ë”í•¨
4) ì ìˆ˜ê°€ ì¶©ë¶„íˆ ë†’ìœ¼ë©´ â€œí˜„ì¬ ëŒ€í™” í† í”½â€ í›„ë³´ë¡œ ì±„íƒ

#### ì™œ Layer 3ì—ì„œ ì¤‘ìš”?
Layer 3ì€ â€œì§€ê¸ˆ ëŒ€í™” íë¦„ì—ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜â€ì„ ë§Œë“¤ê³  ì‹¶ìŠµë‹ˆë‹¤.  
ë”°ë¼ì„œ ë¨¼ì € â€œì§€ê¸ˆ ë¬´ìŠ¨ ì£¼ì œë¥¼ ë§í•˜ê³  ìˆëŠ”ì§€â€ë¥¼ ì•Œì•„ì•¼ ì „í™˜ ì ìˆ˜(transition score)ë¥¼ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


# ============================================================
# ê°œì„ ëœ TopicDetector: ê°€ì¤‘ì¹˜ ê¸°ë°˜ í† í”½ íƒì§€
# ============================================================

class ImprovedTopicDetector:
    """
    ê°€ì¤‘ì¹˜ ê¸°ë°˜ í† í”½ íƒì§€ê¸°

    ê°œì„  ì‚¬í•­:
    1. í‚¤ì›Œë“œë³„ ê°€ì¤‘ì¹˜ ì ìš© (ì¤‘ìš” í‚¤ì›Œë“œ = ë†’ì€ ì ìˆ˜)
    2. ì—¬ëŸ¬ í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œ ì‹œë„ˆì§€ ë³´ë„ˆìŠ¤
    3. ì •ê·œí™”ëœ ì ìˆ˜ (0~1)
    """

    def __init__(self, taxonomy: Dict = TOPIC_TAXONOMY):
        self.taxonomy = taxonomy
        self._build_keyword_index()

    def _build_keyword_index(self):
        """
        í‚¤ì›Œë“œ â†’ í† í”½ ì—­ì¸ë±ìŠ¤ êµ¬ì¶•
        """
        self.keyword_to_topics = defaultdict(list)

        for topic_id, topic_data in self.taxonomy.items():
            weights = topic_data.get("weight", {})

            for keyword in topic_data["keywords"]:
                # í‚¤ì›Œë“œë³„ ê°€ì¤‘ì¹˜ (ê¸°ë³¸ê°’ 1.0)
                weight = weights.get(keyword, 1.0)
                self.keyword_to_topics[keyword].append((topic_id, weight))

    def detect(self, text: str) -> Dict[str, float]:
        """
        í…ìŠ¤íŠ¸ì—ì„œ í† í”½ ì ìˆ˜ ê³„ì‚°

        Parameters
        ----------
        text : str
            ë¶„ì„í•  í…ìŠ¤íŠ¸

        Returns
        -------
        Dict[str, float]
            {í† í”½ID: ì ìˆ˜}
        """
        scores = defaultdict(float)
        matched_keywords = defaultdict(list)

        # ëª¨ë“  í‚¤ì›Œë“œì— ëŒ€í•´ ê²€ì‚¬
        for keyword, topic_weights in self.keyword_to_topics.items():
            if keyword in text:
                for topic_id, weight in topic_weights:
                    scores[topic_id] += weight
                    matched_keywords[topic_id].append(keyword)

        # ì‹œë„ˆì§€ ë³´ë„ˆìŠ¤: ì—¬ëŸ¬ í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œ ì¶”ê°€ ì ìˆ˜
        for topic_id in scores:
            num_keywords = len(matched_keywords[topic_id])
            if num_keywords >= 3:
                scores[topic_id] *= 1.3  # 30% ë³´ë„ˆìŠ¤
            elif num_keywords >= 2:
                scores[topic_id] *= 1.1  # 10% ë³´ë„ˆìŠ¤

        return dict(scores)

    def get_top_topics(
        self,
        text: str,
        top_k: int = 3,
        min_score: float = 0.5
    ) -> List[Tuple[str, float, List[str]]]:
        """
        ìƒìœ„ Kê°œ í† í”½ ë°˜í™˜ (ë§¤ì¹­ëœ í‚¤ì›Œë“œ í¬í•¨)

        Returns
        -------
        List[Tuple[str, float, List[str]]]
            [(í† í”½ID, ì ìˆ˜, [ë§¤ì¹­í‚¤ì›Œë“œë“¤]), ...]
        """
        scores = self.detect(text)

        # ë§¤ì¹­ëœ í‚¤ì›Œë“œ ì°¾ê¸°
        results = []
        for topic_id, score in scores.items():
            if score >= min_score:
                matched = [
                    kw for kw in self.taxonomy[topic_id]["keywords"]
                    if kw in text
                ]
                results.append((topic_id, score, matched))

        # ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        results.sort(key=lambda x: -x[1])

        return results[:top_k]

    def get_primary_topic(self, text: str) -> Optional[str]:
        """ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ í† í”½ ë°˜í™˜"""
        results = self.get_top_topics(text, top_k=1, min_score=0.0)
        return results[0][0] if results else None


# í…ŒìŠ¤íŠ¸
detector = ImprovedTopicDetector()

print(" ImprovedTopicDetector ì •ì˜ ì™„ë£Œ")
print("\n" + "="*60)
print("í…ŒìŠ¤íŠ¸ ê²°ê³¼")
print("="*60)

test_cases = [
    "ìš”ì¦˜ íŒ€í”Œ ë•Œë¬¸ì— ë°”ë¹ ìš”. ë°œí‘œ ì¤€ë¹„ë„ í•´ì•¼ í•˜ê³ .",
    "ì£¼ë§ì— ê°•ì•„ì§€ë‘ ì‚°ì±…í–ˆëŠ”ë° ë‚ ì”¨ê°€ ë„ˆë¬´ ì¢‹ì•˜ì–´.",
    "ì–´ì œ ë„·í”Œë¦­ìŠ¤ì—ì„œ ì˜í™” ë´¤ëŠ”ë° ì§„ì§œ ì¬ë°Œë”ë¼.",
    "ìš”ì¦˜ íšŒì‚¬ ì•¼ê·¼ì´ ë„ˆë¬´ ë§ì•„ì„œ í˜ë“¤ì–´.",
    "ì œì£¼ë„ ì—¬í–‰ ê°€ê³  ì‹¶ë‹¤. ë¹„í–‰ê¸° í‘œ ì•Œì•„ë´ì•¼ì§€.",
]

for text in test_cases:
    results = detector.get_top_topics(text, top_k=2)
    print(f"\n \"{text}\"")
    for topic, score, keywords in results:
        topic_name = TOPIC_TAXONOMY[topic]['name_ko']
        print(f"   â†’ {topic_name}: {score:.1f}ì  (í‚¤ì›Œë“œ: {', '.join(keywords)})")

---
## 4. ê´€ê³„ ë¶„ì„ê¸°

### 4-1. ê´€ê³„ ë¶„ì„ê¸°(RelationshipAnalyzer) ìƒì„¸ ì„¤ëª…

ì´ ì„¹ì…˜ì€ â€œëˆ„ê°€ ëˆ„êµ¬ì—ê²Œ ë§í•˜ëŠ”ê°€?â€ë¥¼ ë¶„ì„í•´, ì¶”ì²œ í† í”½ì— **ê´€ê³„ ì í•©ì„± ì ìˆ˜**ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.

#### ì…ë ¥/ì¶œë ¥
- ì…ë ¥: `user: PersonProfile`, `avatar: PersonProfile`
- ì¶œë ¥: `relationship: Dict`  
  ì˜ˆ) `relationship_type`, `status_gap`, `closeness`, `recommended_formality`, `topic_preferences` ë“±

#### ê´€ê³„ë¥¼ ì™œ ì ìˆ˜í™”í•˜ëŠ”ê°€?
ê°™ì€ ì£¼ì œë¼ë„ **ê´€ê³„ì— ë”°ë¼ ì–´ìš¸ë¦¼ì´ ë‹¤ë¦…ë‹ˆë‹¤.**
- êµìˆ˜ â†” í•™ìƒ: ê³¼ì œ/í•™ì—…/ì§„ë¡œëŠ” ìì—°ìŠ¤ëŸ½ì§€ë§Œ, ì‚¬ì ì¸ ì—°ì• /ì‚¬íšŒì´ìŠˆëŠ” ì¡°ì‹¬
- ì¹œêµ¬ â†” ì¹œêµ¬: ì·¨ë¯¸/ì—°ì˜ˆ/ì—¬í–‰ì´ ìì—°ìŠ¤ëŸ¬ì›€
- ë‚¯ì„  ì‚¬ëŒ: ê°€ë²¼ìš´ ë‚ ì”¨/ì·¨ë¯¸/ìŒì‹ì´ ì•ˆì „

#### ê´€ê³„ ë¶„ì„ ë¡œì§(ê°œë…)
1) **Role ê¸°ë°˜ ì§€ìœ„ ë ˆë²¨**ì„ ìˆ«ìë¡œ ë§¤í•‘ (ì˜ˆ: PROFESSOR > SENIOR > FRIEND)
2) ì‚¬ìš©ìâ€“ì•„ë°”íƒ€ì˜ `status_gap` ê³„ì‚°  
3) `status_gap`ì™€ role ì¡°í•©ìœ¼ë¡œ `relationship_type`ì„ ê²°ì •  
4) ê´€ê³„ íƒ€ì…ì— ë”°ë¼:
   - ê¶Œì¥ ë§íˆ¬(`recommended_formality`) ê²°ì •
   - í† í”½ ì„ í˜¸ë„(`topic_preferences`) í…Œì´ë¸”ì„ ì ìš© (ê° í† í”½ ê°€ì¤‘ì¹˜)

#### Layer 2ì™€ì˜ ì—°ê²°
Layer 2ì—ì„œëŠ” â€œê´€ê³„ ì„ í˜¸ë„ ì ìˆ˜ Ã— (í† í”½ ê¸°ë³¸ ì ìˆ˜)â€ í˜•íƒœë¡œ ê²°í•©í•´  
**ê´€ê³„ì— ë§ì§€ ì•ŠëŠ” í† í”½ì´ ìƒìœ„ë¡œ ì˜¬ë¼ì˜¤ì§€ ì•Šë„ë¡** í•©ë‹ˆë‹¤.


# ============================================================
# ì—­í•  ë° ê´€ê³„ ì •ì˜
# ============================================================

class Role(Enum):
    STUDENT = "student"
    PEER = "peer"
    SENIOR = "senior"
    PROFESSOR = "professor"
    STRANGER = "stranger"

class RelationshipType(Enum):
    FORMAL_HIERARCHICAL = "formal_hierarchical"  # êµìˆ˜-í•™ìƒ
    SEMI_FORMAL = "semi_formal"                  # ì„ ë°°-í›„ë°°
    CASUAL_EQUAL = "casual_equal"                # ì¹œêµ¬
    FIRST_MEETING = "first_meeting"              # ì²˜ìŒ ë§Œë‚¨

ROLE_HIERARCHY = {
    Role.STUDENT: 0,
    Role.PEER: 1,
    Role.SENIOR: 2,
    Role.PROFESSOR: 3,
    Role.STRANGER: 1
}

@dataclass
class PersonProfile:
    name: str
    age: int
    role: Role
    interests: List[str] = field(default_factory=list)
    avoid_topics: List[str] = field(default_factory=list)
    personality: str = ""
    korean_level: str = "native"

print("ì—­í•  ë° í”„ë¡œí•„ ì •ì˜ ì™„ë£Œ")

# ============================================================
# ê´€ê³„-í† í”½ ì í•©ì„± ë§¤íŠ¸ë¦­ìŠ¤ (20ê°œ í† í”½ ë²„ì „)
# ============================================================

TOPIC_COMPATIBILITY = {
    RelationshipType.FORMAL_HIERARCHICAL: {  # êµìˆ˜-í•™ìƒ
        "ê°€ì¡±": 0.3, "ì—°ì• /ê²°í˜¼": 0.1, "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸": 0.4,
        "êµìœ¡": 0.95, "êµ°ëŒ€": 0.3, "ì£¼ê±°ì™€ìƒí™œ": 0.3,
        "êµí†µ": 0.4, "ê±´ê°•": 0.4, "ë¯¸ìš©": 0.1,
        "ê³„ì ˆ/ë‚ ì”¨": 0.6, "ì‹ìŒë£Œ": 0.4, "ìƒê±°ë˜ì „ë°˜": 0.2,
        "ê²Œì„": 0.1, "ìŠ¤í¬ì¸ /ë ˆì €": 0.3, "ë°©ì†¡/ì—°ì˜ˆ": 0.2,
        "ì˜í™”/ë§Œí™”": 0.3, "ì—¬í–‰": 0.5, "ë°˜ë ¤ë™ë¬¼": 0.3,
        "ì‚¬íšŒì´ìŠˆ": 0.2, "íƒ€êµ­ê°€ì´ìŠˆ": 0.2
    },
    RelationshipType.SEMI_FORMAL: {  # ì„ ë°°-í›„ë°°
        "ê°€ì¡±": 0.5, "ì—°ì• /ê²°í˜¼": 0.4, "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸": 0.8,
        "êµìœ¡": 0.85, "êµ°ëŒ€": 0.7, "ì£¼ê±°ì™€ìƒí™œ": 0.6,
        "êµí†µ": 0.6, "ê±´ê°•": 0.6, "ë¯¸ìš©": 0.5,
        "ê³„ì ˆ/ë‚ ì”¨": 0.7, "ì‹ìŒë£Œ": 0.8, "ìƒê±°ë˜ì „ë°˜": 0.6,
        "ê²Œì„": 0.5, "ìŠ¤í¬ì¸ /ë ˆì €": 0.7, "ë°©ì†¡/ì—°ì˜ˆ": 0.6,
        "ì˜í™”/ë§Œí™”": 0.7, "ì—¬í–‰": 0.75, "ë°˜ë ¤ë™ë¬¼": 0.6,
        "ì‚¬íšŒì´ìŠˆ": 0.3, "íƒ€êµ­ê°€ì´ìŠˆ": 0.3
    },
    RelationshipType.CASUAL_EQUAL: {  # ì¹œêµ¬
        "ê°€ì¡±": 0.7, "ì—°ì• /ê²°í˜¼": 0.8, "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸": 0.8,
        "êµìœ¡": 0.75, "êµ°ëŒ€": 0.8, "ì£¼ê±°ì™€ìƒí™œ": 0.8,
        "êµí†µ": 0.7, "ê±´ê°•": 0.8, "ë¯¸ìš©": 0.8,
        "ê³„ì ˆ/ë‚ ì”¨": 0.7, "ì‹ìŒë£Œ": 0.95, "ìƒê±°ë˜ì „ë°˜": 0.8,
        "ê²Œì„": 0.9, "ìŠ¤í¬ì¸ /ë ˆì €": 0.9, "ë°©ì†¡/ì—°ì˜ˆ": 0.9,
        "ì˜í™”/ë§Œí™”": 0.9, "ì—¬í–‰": 0.9, "ë°˜ë ¤ë™ë¬¼": 0.85,
        "ì‚¬íšŒì´ìŠˆ": 0.4, "íƒ€êµ­ê°€ì´ìŠˆ": 0.4
    },
    RelationshipType.FIRST_MEETING: {  # ì²˜ìŒ ë§Œë‚¨
        "ê°€ì¡±": 0.2, "ì—°ì• /ê²°í˜¼": 0.1, "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸": 0.4,
        "êµìœ¡": 0.5, "êµ°ëŒ€": 0.3, "ì£¼ê±°ì™€ìƒí™œ": 0.4,
        "êµí†µ": 0.5, "ê±´ê°•": 0.3, "ë¯¸ìš©": 0.3,
        "ê³„ì ˆ/ë‚ ì”¨": 0.95, "ì‹ìŒë£Œ": 0.7, "ìƒê±°ë˜ì „ë°˜": 0.5,
        "ê²Œì„": 0.4, "ìŠ¤í¬ì¸ /ë ˆì €": 0.6, "ë°©ì†¡/ì—°ì˜ˆ": 0.6,
        "ì˜í™”/ë§Œí™”": 0.7, "ì—¬í–‰": 0.8, "ë°˜ë ¤ë™ë¬¼": 0.6,
        "ì‚¬íšŒì´ìŠˆ": 0.1, "íƒ€êµ­ê°€ì´ìŠˆ": 0.1
    }
}

print("ê´€ê³„-í† í”½ ì í•©ì„± ë§¤íŠ¸ë¦­ìŠ¤ ì •ì˜ ì™„ë£Œ")

# ============================================================
# RelationshipAnalyzer
# ============================================================

class RelationshipAnalyzer:

    def analyze(self, user: PersonProfile, avatar: PersonProfile) -> Dict:
        user_level = ROLE_HIERARCHY.get(user.role, 1)
        avatar_level = ROLE_HIERARCHY.get(avatar.role, 1)
        status_gap = avatar_level - user_level

        rel_type = self._determine_relationship_type(avatar, status_gap)
        formality = self._determine_formality(rel_type)

        common_interests = set(user.interests) & set(avatar.interests)
        avoid_topics = set(user.avoid_topics) | set(avatar.avoid_topics) | set(SENSITIVE_TOPICS)

        return {
            "user_name": user.name,
            "avatar_name": avatar.name,
            "role_pair": f"{user.role.value}-{avatar.role.value}",
            "status_gap": status_gap,
            "relationship_type": rel_type,
            "recommended_formality": formality,
            "common_interests": list(common_interests),
            "avoid_topics": list(avoid_topics)
        }

    def _determine_relationship_type(self, avatar: PersonProfile, status_gap: int) -> RelationshipType:
        if avatar.role == Role.STRANGER:
            return RelationshipType.FIRST_MEETING
        if avatar.role == Role.PROFESSOR:
            return RelationshipType.FORMAL_HIERARCHICAL
        if avatar.role == Role.SENIOR or status_gap >= 1:
            return RelationshipType.SEMI_FORMAL
        return RelationshipType.CASUAL_EQUAL

    def _determine_formality(self, rel_type: RelationshipType) -> str:
        mapping = {
            RelationshipType.FORMAL_HIERARCHICAL: "very_polite",
            RelationshipType.SEMI_FORMAL: "polite",
            RelationshipType.CASUAL_EQUAL: "informal",
            RelationshipType.FIRST_MEETING: "polite"
        }
        return mapping.get(rel_type, "polite")

print("RelationshipAnalyzer ì •ì˜ ì™„ë£Œ")

---
## 5. í† í”½ ì „í™˜ ê·¸ë˜í”„

### 5-1. í† í”½ ì „í™˜ ê·¸ë˜í”„(Transition Graph) ìƒì„¸ ì„¤ëª…

ì´ ì„¹ì…˜ì€ â€œì–´ë–¤ í† í”½ì—ì„œ ì–´ë–¤ í† í”½ìœ¼ë¡œ ë„˜ì–´ê°€ë©´ ìì—°ìŠ¤ëŸ¬ìš´ê°€?â€ë¥¼ ê·¸ë˜í”„ í˜•íƒœë¡œ ëª¨ë¸ë§í•©ë‹ˆë‹¤.

#### ì™œ ê·¸ë˜í”„ê°€ í•„ìš”í•œê°€?
ëŒ€í™”ëŠ” ë³´í†µ **ì—°ê²°ëœ ì—°ìƒ íë¦„**ì„ ê°€ì§‘ë‹ˆë‹¤.
- `ì‹ìŒë£Œ â†’ ì—¬í–‰` (ë§›ì§‘ ì´ì•¼ê¸°í•˜ë‹¤ê°€ ì—¬í–‰ì§€ë¡œ í™•ì¥)
- `êµìœ¡ â†’ ì§„ë¡œ` (ìˆ˜ì—…/ê³¼ì œ ì´ì•¼ê¸°í•˜ë‹¤ê°€ ì»¤ë¦¬ì–´ë¡œ ì—°ê²°)
- `ê±´ê°• â†’ ìŠ¤í¬ì¸ /ë ˆì €` (ìš´ë™/ê±´ê°• ì´ì•¼ê¸°ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§)

ê·¸ë˜í”„ë¥¼ ë‘ë©´ Layer 3ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- **í˜„ì¬ í† í”½ê³¼ ê°€ê¹Œìš´ í† í”½**ì„ ë” ìœ„ë¡œ ì˜¬ë¦¼
- **ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì „í™˜**(ë¬´ê´€í•œ í† í”½)ì„ ì•½ê°„ ë‚´ë ¤ ì•ˆì •ì ì¸ íë¦„ ìƒì„±

#### Layer 3 ì „í™˜ ì ìˆ˜(ê°œë…)
- í˜„ì¬ ëŒ€í™” í† í”½ì´ `A`ì¼ ë•Œ í›„ë³´ í† í”½ì´ `B`ë¼ë©´:
  - ê·¸ë˜í”„ì— `A -> B`ê°€ ìˆìœ¼ë©´ +ì ìˆ˜
  - ì—†ìœ¼ë©´ 0 ë˜ëŠ” ì•½í•œ íŒ¨ë„í‹°
- ì´ ì ìˆ˜ëŠ” â€œê´€ê³„ ì ìˆ˜â€ì™€ í•¨ê»˜ ìµœì¢… ë­í‚¹ì— ë°˜ì˜ë©ë‹ˆë‹¤.

#### í™•ì¥ í¬ì¸íŠ¸
- ì‹¤ì œ ì•± ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ â€œì‚¬ìš©ìë“¤ì´ ìì£¼ ì´ë™í•˜ëŠ” í† í”½ ì „í™˜â€ì„ í†µê³„ì ìœ¼ë¡œ ì¶”ì •í•´
  ê·¸ë˜í”„ë¥¼ ìë™ ì—…ë°ì´íŠ¸í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë°œì „ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


# ============================================================
# í† í”½ ì „í™˜ ê·¸ë˜í”„ (ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” íë¦„)
# ============================================================

TOPIC_TRANSITIONS = {
    "êµìœ¡": ["íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸", "ì‹ìŒë£Œ", "ìŠ¤í¬ì¸ /ë ˆì €", "ê³„ì ˆ/ë‚ ì”¨"],
    "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸": ["êµìœ¡", "ì‹ìŒë£Œ", "ê±´ê°•", "ì—¬í–‰", "ì£¼ê±°ì™€ìƒí™œ"],
    "ê°€ì¡±": ["ì—¬í–‰", "ì‹ìŒë£Œ", "ê±´ê°•", "ë°˜ë ¤ë™ë¬¼"],
    "ì—°ì• /ê²°í˜¼": ["ê°€ì¡±", "ì‹ìŒë£Œ", "ì—¬í–‰", "ì˜í™”/ë§Œí™”"],
    "ê±´ê°•": ["ìŠ¤í¬ì¸ /ë ˆì €", "ì‹ìŒë£Œ", "ë¯¸ìš©"],
    "ë¯¸ìš©": ["ê±´ê°•", "ìƒê±°ë˜ì „ë°˜", "ë°©ì†¡/ì—°ì˜ˆ"],
    "ì‹ìŒë£Œ": ["ì—¬í–‰", "ìƒê±°ë˜ì „ë°˜", "ë°©ì†¡/ì—°ì˜ˆ", "ê³„ì ˆ/ë‚ ì”¨"],
    "ì—¬í–‰": ["ì‹ìŒë£Œ", "êµí†µ", "ê³„ì ˆ/ë‚ ì”¨", "ë°˜ë ¤ë™ë¬¼"],
    "ê²Œì„": ["ì˜í™”/ë§Œí™”", "ë°©ì†¡/ì—°ì˜ˆ", "ìŠ¤í¬ì¸ /ë ˆì €"],
    "ìŠ¤í¬ì¸ /ë ˆì €": ["ê±´ê°•", "ì—¬í–‰", "ê²Œì„", "ê³„ì ˆ/ë‚ ì”¨"],
    "ë°©ì†¡/ì—°ì˜ˆ": ["ì˜í™”/ë§Œí™”", "ê²Œì„", "ì‹ìŒë£Œ"],
    "ì˜í™”/ë§Œí™”": ["ë°©ì†¡/ì—°ì˜ˆ", "ê²Œì„", "ì‹ìŒë£Œ"],
    "ë°˜ë ¤ë™ë¬¼": ["ê°€ì¡±", "ì—¬í–‰", "ê±´ê°•"],
    "ì£¼ê±°ì™€ìƒí™œ": ["ìƒê±°ë˜ì „ë°˜", "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸"],
    "êµí†µ": ["ì—¬í–‰", "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸", "ì£¼ê±°ì™€ìƒí™œ"],
    "ìƒê±°ë˜ì „ë°˜": ["ì‹ìŒë£Œ", "ë¯¸ìš©", "ì£¼ê±°ì™€ìƒí™œ"],
    "ê³„ì ˆ/ë‚ ì”¨": ["ì—¬í–‰", "ì‹ìŒë£Œ", "ìŠ¤í¬ì¸ /ë ˆì €"],  # ìŠ¤ëª°í† í¬ â†’ ë‹¤ë¥¸ ì£¼ì œ
    "êµ°ëŒ€": ["ê°€ì¡±", "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸", "êµìœ¡"],
    "ì‚¬íšŒì´ìŠˆ": [],  # ì „í™˜ ë¹„ì¶”ì²œ
    "íƒ€êµ­ê°€ì´ìŠˆ": []  # ì „í™˜ ë¹„ì¶”ì²œ
}

def get_transition_score(from_topic: str, to_topic: str) -> float:
    if from_topic == to_topic:
        return 0.5
    if to_topic in TOPIC_TRANSITIONS.get(from_topic, []):
        return 1.0
    # ê°„ì ‘ ì—°ê²°
    for mid in TOPIC_TRANSITIONS.get(from_topic, []):
        if to_topic in TOPIC_TRANSITIONS.get(mid, []):
            return 0.6
    return 0.3

print(" í† í”½ ì „í™˜ ê·¸ë˜í”„ ì •ì˜ ì™„ë£Œ")

---
## 6. í†µí•© ì¶”ì²œ ì‹œìŠ¤í…œ

### 6-1. í†µí•© ì¶”ì²œ ì‹œìŠ¤í…œ(TopicRecommendationSystem) â€” ë ˆì´ì–´ë³„ ìƒì„¸ ë™ì‘

ì´ ì„¹ì…˜ì´ ë…¸íŠ¸ë¶ì˜ í•µì‹¬ì…ë‹ˆë‹¤. ì•ì˜ êµ¬ì„±ìš”ì†Œë“¤ì„ ì¡°í•©í•´ **ìµœì¢… í† í”½ ì¶”ì²œ + ì‹œì‘ ë¬¸ì¥ ìƒì„±**ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

---

## A) ì£¼ìš” ë°ì´í„° êµ¬ì¡°

### `PersonProfile`
ì‚¬ìš©ì/ì•„ë°”íƒ€ë¥¼ ë™ì¼í•œ êµ¬ì¡°ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.
- `role`: êµìˆ˜/ì„ ë°°/ì¹œêµ¬/ë‚¯ì„  ì‚¬ëŒ ë“±
- `interests`: ê´€ì‹¬ í† í”½(ê°œì¸í™”)
- `avoid_topics`: íšŒí”¼ í† í”½(ì•ˆì „)
- `korean_level`: ì–¸ì–´ ìˆ˜ì¤€(ë¬¸ì¥ ë‚œì´ë„/ë§íˆ¬ ì¡°ì ˆìš©)

### `TopicRecommendation`
ì¶”ì²œ ê²°ê³¼ë¥¼ ë‹´ëŠ” êµ¬ì¡°ì²´ì…ë‹ˆë‹¤.
- `topic_id`, `topic_name`
- `score`: ìµœì¢… ì ìˆ˜
- `compatibility_score`: ê´€ê³„ ì í•©ì„±/ë§¥ë½ ì ìˆ˜ ë“±ì˜ ê²°í•© ê°’
- `starter_sentences`: ìµœì¢… ì‹œì‘ ë¬¸ì¥ ë¦¬ìŠ¤íŠ¸

---

## B) ë ˆì´ì–´ë³„ ì²˜ë¦¬ íë¦„

### Layer 1: Rule-Based Filtering
ëª©í‘œ: **ì¶”ì²œí•˜ë©´ ì•ˆ ë˜ëŠ” í† í”½ì„ ë¨¼ì € ì œê±°**
- ì‚¬ìš©ìì˜ `avoid_topics` ì œê±°
- ê´€ê³„ íƒ€ì…ìƒ ìœ„í—˜í•œ í† í”½(ì˜ˆ: STRANGERì—ê²Œ ì‚¬íšŒì´ìŠˆ ë“±) ì œí•œ
- â€œì•ˆì „í•˜ê³  ê°€ë²¼ìš´ í† í”½â€ì„ ê¸°ë³¸ í›„ë³´ë¡œ ìœ ì§€

### Layer 2: Relationship Scoring
ëª©í‘œ: â€œê´€ê³„ì— ë§ëŠ” í† í”½ì„ ìœ„ë¡œ ì˜¬ë¦¬ê¸°â€
- `RelationshipAnalyzer`ê°€ ë§Œë“  `topic_preferences` ê°€ì¤‘ì¹˜ë¥¼ ì‚¬ìš©
- ì˜ˆ: êµìˆ˜ ê´€ê³„ì—ì„œëŠ” â€œêµìœ¡/ì§„ë¡œ/ì—…ë¬´â€ ê°€ì¤‘ì¹˜â†‘, â€œì—°ì• /ì‚¬íšŒì´ìŠˆâ€ ê°€ì¤‘ì¹˜â†“

### Layer 3: Context-Aware Ranking
ëª©í‘œ: â€œì§€ê¸ˆ ëŒ€í™” íë¦„ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” í† í”½â€ ìš°ì„ 
- `ImprovedTopicDetector`ë¡œ í˜„ì¬ ëŒ€í™” í† í”½ í›„ë³´ë¥¼ ê°ì§€
- `TRANSITION_GRAPH`ë¡œ ì „í™˜ ê°€ëŠ¥ì„±ì´ ë†’ì€ í† í”½ì— ê°€ì‚°ì 

---

## C) Layer 4: Starter Generation (ë¹„ìš©â†“, ì•ˆì •ì„±â†‘)

ì´ ë…¸íŠ¸ë¶ì—ì„œ Layer 4ëŠ” ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤.

### 1) í…œí”Œë¦¿ ìš°ì„ (Template-first)
- `STARTER_TEMPLATES[topic_id]`ì—ì„œ **2ê°œ ì •ë„**ë¥¼ ì„ íƒ
- ì¥ì : ë§íˆ¬/ì¡´ëŒ“ë§ì´ ì•ˆì •ì , ë°ëª¨ê°€ í”ë“¤ë¦¬ì§€ ì•ŠìŒ

### 2) LLMì€ â€œìƒìœ„ Nê°œ í† í”½â€ë§Œ(ê¸°ë³¸ 2ê°œ)
- `LLM_TOP_N = 2`
- ìƒìœ„ í† í”½ 1~2ê°œë§Œ LLMë¡œ ë” ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ë“¬ëŠ” ë°©ì‹
- ë‚˜ë¨¸ì§€ëŠ” í…œí”Œë¦¿ìœ¼ë¡œ ìœ ì§€ â†’ ë¹„ìš©/ì§€ì—°/ë¶ˆì•ˆì •ì„± ìµœì†Œí™”

### 3) ìºì‹œë¡œ ì¬ì‚¬ìš© (í•µì‹¬)
- ìºì‹œ í‚¤: `(topic_id, relationship_type, korean_level)`
- ê°™ì€ ìƒí™©ì—ì„œ ë°˜ë³µ ì¶”ì²œë  ë•Œ **í•­ìƒ ê°™ì€ ê²°ê³¼**ë¥¼ ì¬ì‚¬ìš© â†’ ì†ë„â†‘, ë¹„ìš©â†“, ì¼ê´€ì„±â†‘

### 4) â€œë°˜ë³µë˜ë©´ LLMâ€ ê°™ì€ ì •ì±…ë„ ê°€ëŠ¥
- `_starter_usage` ê°™ì€ ì¹´ìš´í„°ë¡œ íŠ¹ì • í‚¤ê°€ ë„ˆë¬´ ìì£¼ ì“°ì´ë©´
  LLM ê°œì„ ì„ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì‚¬ìš©ì ê²½í—˜ ê°œì„ ).

---


# ============================================================
# ëŒ€í™” ì‹œì‘ ë¬¸ì¥ í…œí”Œë¦¿
# ============================================================

STARTER_TEMPLATES = {
    "êµìœ¡": [
        "ìš”ì¦˜ ê³µë¶€ ì–´ë–»ê²Œ í•˜ê³  ìˆì–´ìš”?",
        "ì‹œí—˜ ì¤€ë¹„ëŠ” ì˜ ë˜ê³  ìˆì–´ìš”?",
        "ì–´ë–¤ ê³¼ëª©ì´ ì œì¼ ì¬ë°Œì–´ìš”?"
    ],
    "íšŒì‚¬/ì•„ë¥´ë°”ì´íŠ¸": [
        "ìš”ì¦˜ ì¼ì€ ì–´ë•Œìš”?",
        "ì•Œë°” í˜ë“¤ì§€ ì•Šì•„ìš”?",
        "íšŒì‚¬ ìƒí™œì€ ì–´ë•Œìš”?"
    ],
    "ì‹ìŒë£Œ": [
        "ì ì‹¬ ë­ ë¨¹ì—ˆì–´ìš”?",
        "ìš”ì¦˜ ë§›ì§‘ ë‹¤ë…€ì˜¨ ë° ìˆì–´ìš”?",
        "ì»¤í”¼ ì¢‹ì•„í•´ìš”?"
    ],
    "ì—¬í–‰": [
        "ìµœê·¼ì— ì—¬í–‰ ë‹¤ë…€ì™”ì–´ìš”?",
        "ê°€ë³´ê³  ì‹¶ì€ ê³³ ìˆì–´ìš”?",
        "ì œì£¼ë„ ê°€ë³¸ ì  ìˆì–´ìš”?"
    ],
    "ì˜í™”/ë§Œí™”": [
        "ìš”ì¦˜ ë­ ë³´ê³  ìˆì–´ìš”?",
        "ì˜í™” ì¶”ì²œí•´ì¤„ ìˆ˜ ìˆì–´ìš”?",
        "ë„·í”Œë¦­ìŠ¤ ë­ ë´ìš”?"
    ],
    "ë°©ì†¡/ì—°ì˜ˆ": [
        "ìš”ì¦˜ ë³´ëŠ” ë“œë¼ë§ˆ ìˆì–´ìš”?",
        "ì¢‹ì•„í•˜ëŠ” ê°€ìˆ˜ ìˆì–´ìš”?",
        "ì˜ˆëŠ¥ ë­ ë´ìš”?"
    ],
    "ê²Œì„": [
        "ìš”ì¦˜ ë¬´ìŠ¨ ê²Œì„ í•´ìš”?",
        "ê²Œì„ ì¢‹ì•„í•´ìš”?",
        "ë¡¤ í•´ë´¤ì–´ìš”?"
    ],
    "ìŠ¤í¬ì¸ /ë ˆì €": [
        "ìš´ë™ ë­ ì¢‹ì•„í•´ìš”?",
        "ì£¼ë§ì— ë­ í•˜ê³  ë†€ì•„ìš”?",
        "ë“±ì‚° ê°€ë³¸ ì  ìˆì–´ìš”?"
    ],
    "ê³„ì ˆ/ë‚ ì”¨": [
        "ì˜¤ëŠ˜ ë‚ ì”¨ ì¢‹ì§€ ì•Šì•„ìš”?",
        "ìš”ì¦˜ ë§ì´ ì¶¥ì£ ?",
        "ë¹„ ì˜¬ ê²ƒ ê°™ì€ë°ìš”."
    ],
    "ë°˜ë ¤ë™ë¬¼": [
        "ê°•ì•„ì§€ í‚¤ì›Œìš”?",
        "ë°˜ë ¤ë™ë¬¼ ìˆì–´ìš”?",
        "ê³ ì–‘ì´ ì¢‹ì•„í•´ìš”?"
    ],
    "ê±´ê°•": [
        "ìš”ì¦˜ ìš´ë™ í•˜ê³  ìˆì–´ìš”?",
        "ê±´ê°• ê´€ë¦¬ ì–´ë–»ê²Œ í•´ìš”?",
        "ì ì€ ì˜ ììš”?"
    ],
    "ë¯¸ìš©": [
        "ë¨¸ë¦¬ ì–´ë””ì„œ ì˜ë¼ìš”?",
        "í”¼ë¶€ ê´€ë¦¬ ì–´ë–»ê²Œ í•´ìš”?",
        "ì—¼ìƒ‰ í•´ë³¸ ì  ìˆì–´ìš”?"
    ],
    "ì£¼ê±°ì™€ìƒí™œ": [
        "ì–´ë”” ì‚´ì•„ìš”?",
        "ìì·¨í•´ìš”?",
        "ì§‘ êµ¬í•˜ê¸° í˜ë“¤ì§€ ì•Šì•„ìš”?"
    ],
    "ê°€ì¡±": [
        "ê°€ì¡±ì€ ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?",
        "í˜•ì œìë§¤ ìˆì–´ìš”?",
        "ë¶€ëª¨ë‹˜ì€ ì–´ë”” ì‚¬ì„¸ìš”?"
    ]
}

print("ëŒ€í™” ì‹œì‘ ë¬¸ì¥ í…œí”Œë¦¿ ì •ì˜ ì™„ë£Œ")

# ============================================================
# TopicRecommendationSystem: í†µí•© ì¶”ì²œ ì‹œìŠ¤í…œ
# ============================================================

@dataclass
class TopicRecommendation:
    topic_id: str
    topic_name: str
    score: float
    compatibility_score: float
    interest_score: float
    transition_score: float
    starter_sentences: List[str]
    reason: str


class TopicRecommendationSystem:
    """
    í†µí•© í† í”½ ì¶”ì²œ ì‹œìŠ¤í…œ

    ì¶”ì²œ ì ìˆ˜ = 0.40 Ã— ê´€ê³„ì í•©ì„± + 0.35 Ã— ê´€ì‹¬ì‚¬ + 0.25 Ã— ì „í™˜ìì—°ìŠ¤ëŸ¬ì›€
    """

    W_COMPATIBILITY = 0.40
    W_INTEREST = 0.35
    W_TRANSITION = 0.25

    def __init__(self):
        self.detector = ImprovedTopicDetector()
        self.analyzer = RelationshipAnalyzer()

        # ====================================================
        # Layer 4 (Conversation Starters): cheaper + reliable
        # - templates first
        # - LLM only for top N topics or when templates feel repetitive
        # - cache per (topic + relationship_type + korean_level)
        # ====================================================
        # cache: key -> {"starters": List[str], "is_llm": bool}
        self.starter_cache: Dict[Tuple[str, str, str], Dict] = {}
        self._starter_usage = defaultdict(int)
        self.LLM_TOP_N = 2

    def _rel_key(self, relationship_type) -> str:
        # relationship_type might be Enum
        return getattr(relationship_type, "value", str(relationship_type))

    def _starter_cache_key(self, topic_id: str, relationship: Dict, user: PersonProfile) -> Tuple[str, str, str]:
        return (topic_id, self._rel_key(relationship.get("relationship_type")), user.korean_level)

    def _apply_formality_prefix(self, s: str, relationship: Dict, avatar: PersonProfile) -> str:
        formality = relationship.get("recommended_formality", "polite")

        # professor / very polite cases: add respectful address cue
        if avatar.role == Role.PROFESSOR or formality in ["very_polite"]:
            if not re.match(r"^(êµìˆ˜ë‹˜|ì„ ìƒë‹˜|.*ë‹˜)[, ]", s):
                return f"{avatar.name}ë‹˜, {s}"
        return s

    def _template_starters(self, topic_id: str, relationship: Dict, avatar: PersonProfile, k: int = 2) -> List[str]:
        base = STARTER_TEMPLATES.get(topic_id, ["ì´ ì£¼ì œì— ëŒ€í•´ ì´ì•¼ê¸°í•´ìš”."])
        base = base[:]  # copy
        random.shuffle(base)
        starters = [self._apply_formality_prefix(x, relationship, avatar) for x in base[:k]]
        return starters

    def _templates_feel_repetitive(self, key: Tuple[str, str, str]) -> bool:
        # After a couple uses, treat templates as repetitive
        return self._starter_usage[key] >= 2

    def _llm_enhance_starters(
        self,
        topic_name: str,
        base_starters: List[str],
        relationship: Dict,
        user: PersonProfile,
        avatar: PersonProfile,
        current_dialogue: str = ""
    ) -> List[str]:
        '''
        Optional: replace this stub with your CLOVA Studio / OpenAI-compatible call.
        For demo stability, this returns base_starters unless you later wire an API client.
        '''
        if not USE_LLM:
            return base_starters
        return base_starters

    def _get_starters(
        self,
        topic_id: str,
        topic_name: str,
        relationship: Dict,
        user: PersonProfile,
        avatar: PersonProfile,
        current_dialogue: str = "",
        allow_llm: bool = False
    ) -> List[str]:
        key = self._starter_cache_key(topic_id, relationship, user)

        # Count usage (used to detect repetition)
        self._starter_usage[key] += 1

        cached = self.starter_cache.get(key)
        repetitive = self._templates_feel_repetitive(key)

        # If cached exists and we don't need to upgrade to LLM, return
        if cached and not ((allow_llm or repetitive) and not cached.get("is_llm", False)):
            return cached["starters"]

        # templates first
        base = self._template_starters(topic_id, relationship, avatar, k=2)

        # LLM only when allowed (top N) OR templates feel repetitive
        starters = base
        used_llm = False
        if (allow_llm or repetitive) and USE_LLM:
            starters = self._llm_enhance_starters(
                topic_name=topic_name,
                base_starters=base,
                relationship=relationship,
                user=user,
                avatar=avatar,
                current_dialogue=current_dialogue or ""
            )
            used_llm = True

        # cache final
        self.starter_cache[key] = {"starters": starters, "is_llm": used_llm}
        return starters


    def recommend(
        self,
        user: PersonProfile,
        avatar: PersonProfile,
        current_dialogue: str = "",
        current_topic: Optional[str] = None,
        top_k: int = 5
    ) -> Dict:
        """
        í† í”½ ì¶”ì²œ ìˆ˜í–‰
        """
        # 1. ê´€ê³„ ë¶„ì„
        relationship = self.analyzer.analyze(user, avatar)
        rel_type = relationship["relationship_type"]
        avoid_topics = set(relationship["avoid_topics"])

        # 2. í˜„ì¬ í† í”½ íƒì§€
        current_topics = []
        if current_dialogue:
            detected = self.detector.get_top_topics(current_dialogue, top_k=2)
            current_topics = [
                {"id": t[0], "name": TOPIC_TAXONOMY[t[0]]["name_ko"],
                 "score": t[1], "keywords": t[2]}
                for t in detected
            ]
            if detected and not current_topic:
                current_topic = detected[0][0]

        # 3. ê° í† í”½ ì ìˆ˜ ê³„ì‚°
        recommendations = []

        for topic_id, topic_data in TOPIC_TAXONOMY.items():
            # í•„í„°ë§
            if topic_id in avoid_topics:
                continue
            if topic_data.get("is_sensitive", False):
                continue

            # ì ìˆ˜ ê³„ì‚°
            compatibility = TOPIC_COMPATIBILITY.get(rel_type, {}).get(topic_id, 0.5)

            interest = 0.5
            if topic_id in user.interests and topic_id in avatar.interests:
                interest = 1.0
            elif topic_id in user.interests or topic_id in avatar.interests:
                interest = 0.7

            transition = 0.5
            if current_topic:
                transition = get_transition_score(current_topic, topic_id)

            final_score = (
                self.W_COMPATIBILITY * compatibility +
                self.W_INTEREST * interest +
                self.W_TRANSITION * transition
            )
            # ì‹œì‘ ë¬¸ì¥ (Layer 4ì—ì„œ top-Kì— ëŒ€í•´ ìƒì„±/ìºì‹œ)
            starters = []

            # ì¶”ì²œ ì´ìœ 
            reasons = []
            if compatibility >= 0.8:
                reasons.append(f"{avatar.name}ë‹˜ê³¼ì˜ ê´€ê³„ì— ì í•©")
            if interest >= 0.9:
                reasons.append("ê³µí†µ ê´€ì‹¬ì‚¬")
            elif interest >= 0.7:
                reasons.append("ê´€ì‹¬ ìˆëŠ” ì£¼ì œ")
            if transition >= 0.8:
                reasons.append("ìì—°ìŠ¤ëŸ¬ìš´ ì „í™˜")
            if not reasons:
                reasons.append("ì•ˆì „í•œ ëŒ€í™” ì£¼ì œ")

            recommendations.append(TopicRecommendation(
                topic_id=topic_id,
                topic_name=topic_data["name_ko"],
                score=round(final_score, 3),
                compatibility_score=round(compatibility, 3),
                interest_score=round(interest, 3),
                transition_score=round(transition, 3),
                starter_sentences=[],
                reason=", ".join(reasons)
            ))

        # ì •ë ¬
        recommendations.sort(key=lambda x: -x.score)
        top_recommendations = recommendations[:top_k]

        #  Layer 4: starters (template-first, LLM only for top N, cached)
        for i, r in enumerate(top_recommendations):
            r.starter_sentences = self._get_starters(
                topic_id=r.topic_id,
                topic_name=r.topic_name,
                relationship=relationship,
                user=user,
                avatar=avatar,
                current_dialogue=current_dialogue or "",
                allow_llm=(USE_LLM and i < self.LLM_TOP_N)
            )


        # ê²°ê³¼
        return {
            "relationship": relationship,
            "current_topics": current_topics,
            "recommendations": [
                {
                    "rank": i + 1,
                    "topic_id": r.topic_id,
                    "topic_name": r.topic_name,
                    "score": r.score,
                    "scores": {
                        "compatibility": r.compatibility_score,
                        "interest": r.interest_score,
                        "transition": r.transition_score
                    },
                    "starters": r.starter_sentences,
                    "reason": r.reason
                }
                for i, r in enumerate(top_recommendations)
            ],
            "summary": self._generate_summary(relationship, top_recommendations)
        }

    def _generate_summary(self, relationship: Dict, recommendations: List) -> str:
        if not recommendations:
            return "ì¶”ì²œí•  í† í”½ì´ ì—†ìŠµë‹ˆë‹¤."
        top = recommendations[0]
        formality = {"very_polite": "ìŠµë‹ˆë‹¤ì²´", "polite": "í•´ìš”ì²´", "informal": "ë°˜ë§"}
        return (
            f"{relationship['avatar_name']}ë‹˜ê³¼ì˜ ëŒ€í™”ì—ì„œëŠ” "
            f"'{top.topic_name}' ì£¼ì œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤. "
            f"{formality.get(relationship['recommended_formality'], 'í•´ìš”ì²´')}ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
        )

print(" TopicRecommendationSystem ì •ì˜ ì™„ë£Œ")

---
## 7. ê²°ê³¼ ì¶œë ¥ í•¨ìˆ˜

### 7-1. ê²°ê³¼ ì¶œë ¥ í•¨ìˆ˜(print_result) ì„¤ëª…

`print_result(result)`ëŠ” ì¶”ì²œ ì—”ì§„ì´ ë°˜í™˜í•œ ë”•ì…”ë„ˆë¦¬ë¥¼ **ë°ëª¨/ë””ë²„ê¹…ìš©ìœ¼ë¡œ ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥**í•©ë‹ˆë‹¤.

####  ì¶œë ¥ ë‚´ìš©
- ê´€ê³„ ë¶„ì„ ê²°ê³¼(ê´€ê³„ íƒ€ì…, ì§€ìœ„ ì°¨ì´, ê¶Œì¥ ë§íˆ¬)
- ì¶”ì²œ í† í”½ ë¦¬ìŠ¤íŠ¸(ì ìˆ˜, ì í•©ì„± ì ìˆ˜)
- ê° í† í”½ì˜ ì‹œì‘ ë¬¸ì¥(í…œí”Œë¦¿/LLM ê²°ê³¼)

#### ì‹¤ë¬´ì ìœ¼ë¡œ ìœ ìš©í•œ ì´ìœ 
- ëª¨ë¸ì´ â€œì™œ ì´ í† í”½ì„ ì¶”ì²œí–ˆëŠ”ì§€â€ë¥¼ ë¹ ë¥´ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŒ
- ë°ëª¨ ë°œí‘œì—ì„œ ì‹œê°ì ìœ¼ë¡œ ê²°ê³¼ë¥¼ ì„¤ëª…í•˜ê¸° ì‰¬ì›€


def print_result(result: Dict):
    rel = result["relationship"]

    print("=" * 65)
    print(" ê´€ê³„ ë¶„ì„")
    print("=" * 65)
    print(f"   ì‚¬ìš©ì: {rel['user_name']}")
    print(f"   ì•„ë°”íƒ€: {rel['avatar_name']}")
    print(f"   ê´€ê³„: {rel['role_pair']}")
    print(f"   ê¶Œì¥ ë§íˆ¬: {rel['recommended_formality']}")

    if result["current_topics"]:
        print("\n í˜„ì¬ ëŒ€í™” í† í”½:")
        for t in result["current_topics"]:
            print(f"    - {t['name']}: {t['score']:.1f}ì  (í‚¤ì›Œë“œ: {', '.join(t['keywords'][:3])})")

    print("\n" + "=" * 65)
    print(" í† í”½ ì¶”ì²œ")
    print("=" * 65)

    for rec in result["recommendations"]:
        print(f"\n  [{rec['rank']}ìœ„] {rec['topic_name']}")
        print(f"       ì ìˆ˜: {rec['score']:.3f}")
        print(f"       ê´€ê³„:{rec['scores']['compatibility']:.2f} | ê´€ì‹¬:{rec['scores']['interest']:.2f} | ì „í™˜:{rec['scores']['transition']:.2f}")
        print(f"       ì´ìœ : {rec['reason']}")
        print(f"       ì‹œì‘: \"{rec['starters'][0]}\"")

    print("\n" + "-" * 65)
    print(f" {result['summary']}")
    print("-" * 65)

print(" ì¶œë ¥ í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ")

---
## 8. í…ŒìŠ¤íŠ¸

### 8-1. í…ŒìŠ¤íŠ¸(í”„ë¡œí•„ ìƒì„± ë° ì‹¤í–‰) ì„¤ëª…

ì—¬ê¸°ì„œëŠ” ì‹¤ì œ ì•± ìƒí™©ì„ ê°€ì •í•´ `PersonProfile`ì„ ë§Œë“¤ê³  ì¶”ì²œ ì‹œìŠ¤í…œì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

#### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì„±
- ì‚¬ìš©ì: ë‚˜ì´/ê´€ì‹¬ì‚¬/íšŒí”¼ í† í”½/í•œêµ­ì–´ ìˆ˜ì¤€ ì„¤ì •
- ì•„ë°”íƒ€: êµìˆ˜/ì„ ë°°/ì¹œêµ¬ ë“± Roleì„ ë°”ê¿”ê°€ë©° ê²°ê³¼ê°€ ì–´ë–»ê²Œ ë‹¬ë¼ì§€ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥
- `current_dialogue`: ìµœê·¼ ëŒ€í™” í…ìŠ¤íŠ¸ë¥¼ ë„£ì–´ Layer 3 íš¨ê³¼(ë§¥ë½ ë°˜ì˜)ë¥¼ í™•ì¸

#### í™•ì¸í•´ì•¼ í•  í¬ì¸íŠ¸(ì²´í¬ë¦¬ìŠ¤íŠ¸)
- íšŒí”¼ í† í”½ì´ ì‹¤ì œë¡œ ì¶”ì²œì—ì„œ ë¹ ì§€ëŠ”ê°€? (Layer 1)
- êµìˆ˜/ì¹œêµ¬/ë‚¯ì„  ì‚¬ëŒì— ë”°ë¼ ì¶”ì²œ í† í”½ì´ ë°”ë€ŒëŠ”ê°€? (Layer 2)
- í˜„ì¬ ëŒ€í™” í† í”½ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” ì£¼ì œê°€ ì˜¬ë¼ì˜¤ëŠ”ê°€? (Layer 3)
- ì‹œì‘ ë¬¸ì¥ì´ í…œí”Œë¦¿ ê¸°ë°˜ìœ¼ë¡œ ì•ˆì •ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ê°€? (Layer 4)
- ë™ì¼ ìƒí™©ì—ì„œ ë°˜ë³µ ì‹¤í–‰ ì‹œ ê²°ê³¼ê°€ ìºì‹œë¡œ ì¬ì‚¬ìš©ë˜ëŠ”ê°€? (Layer 4 ìºì‹œ)


# í”„ë¡œí•„ ìƒì„±
user = PersonProfile(
    name="ì§€ë¯¼",
    age=23,
    role=Role.STUDENT,
    interests=["ê²Œì„", "ì˜í™”/ë§Œí™”", "ì‹ìŒë£Œ", "ì—¬í–‰"],
    avoid_topics=["ì‚¬íšŒì´ìŠˆ"],
    korean_level="intermediate"
)

professor = PersonProfile(
    name="ê¹€ êµìˆ˜ë‹˜",
    age=55,
    role=Role.PROFESSOR,
    interests=["êµìœ¡", "ì—¬í–‰", "ê±´ê°•"]
)

senior = PersonProfile(
    name="ë¯¼ìˆ˜ ì„ ë°°",
    age=26,
    role=Role.SENIOR,
    interests=["ê²Œì„", "ìŠ¤í¬ì¸ /ë ˆì €", "ì‹ìŒë£Œ"]
)

friend = PersonProfile(
    name="ìˆ˜ì§„",
    age=22,
    role=Role.PEER,
    interests=["ì˜í™”/ë§Œí™”", "ë°©ì†¡/ì—°ì˜ˆ", "ì‹ìŒë£Œ", "ì—¬í–‰"]
)

system = TopicRecommendationSystem()
print(" í…ŒìŠ¤íŠ¸ í”„ë¡œí•„ ìƒì„± ì™„ë£Œ")

print("\n" + "#" * 65)
print("# ì‹œë‚˜ë¦¬ì˜¤ 1: êµìˆ˜ë‹˜ê³¼ ëŒ€í™” ì‹œì‘")
print("#" * 65)

result1 = system.recommend(user, professor, top_k=5)
print_result(result1)

print("\n" + "#" * 65)
print("# ì‹œë‚˜ë¦¬ì˜¤ 2: ì„ ë°°ì™€ ëŒ€í™” ì¤‘ (í˜„ì¬: ê²Œì„ ì–˜ê¸°)")
print("#" * 65)

dialogue = "ì„ ë°°, ìš”ì¦˜ ë¡¤ ë§ì´ í•´ìš”? ì € ì–´ì œ ë­í¬ ì˜¬ë ¸ì–´ìš”!"
print(f"\ní˜„ì¬ ëŒ€í™”: \"{dialogue}\"\n")

result2 = system.recommend(user, senior, current_dialogue=dialogue, top_k=5)
print_result(result2)

print("\n" + "#" * 65)
print("# ì‹œë‚˜ë¦¬ì˜¤ 3: ì¹œêµ¬ì™€ ëŒ€í™” ì‹œì‘")
print("#" * 65)

result3 = system.recommend(user, friend, top_k=5)
print_result(result3)

print("\n" + "#" * 65)
print("# ì‹œë‚˜ë¦¬ì˜¤ 4: ì¹œêµ¬ì™€ ëŒ€í™” ì¤‘ (í˜„ì¬: ë§›ì§‘ ì–˜ê¸°)")
print("#" * 65)

dialogue2 = "ì–´ì œ í™ëŒ€ ë§›ì§‘ ê°”ëŠ”ë° ì¹˜í‚¨ì´ ì§„ì§œ ë§›ìˆë”ë¼! ë°°ë‹¬ë„ ë˜ë˜ë°."
print(f"\ní˜„ì¬ ëŒ€í™”: \"{dialogue2}\"\n")

result4 = system.recommend(user, friend, current_dialogue=dialogue2, top_k=5)
print_result(result4)

---
## 9. ì‹œìŠ¤í…œ ìš”ì•½

## 9-1. ìš´ì˜/í™•ì¥ ê°€ì´ë“œ (ì‹¤ì œ ì•±ì— ë¶™ì¼ ë•Œ)

ì´ ë…¸íŠ¸ë¶ì€ â€œì—°êµ¬Â·ë³´ê³ ì„œÂ·ë°ëª¨â€ì— ìµœì í™”ë˜ì–´ ìˆì§€ë§Œ, ì•±ì— ë¶™ì¼ ë•Œë„ êµ¬ì¡°ê°€ ê·¸ëŒ€ë¡œ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### ìš´ì˜ ì‹œ ê¶Œì¥ ì„¤ì •
- ê¸°ë³¸ì€ **í…œí”Œë¦¿ ì¤‘ì‹¬**ìœ¼ë¡œ ìš´ì˜í•˜ê³ , LLMì€ ìƒìœ„ 1~2ê°œë§Œ ì‚¬ìš©
- ìºì‹œë¥¼ ì¼œì„œ ì‘ë‹µì„ ë¹ ë¥´ê²Œ ìœ ì§€
- ë¯¼ê° í† í”½ì€ í”„ë¡œí•„/ê·œì¹™ìœ¼ë¡œ ë¨¼ì € ì°¨ë‹¨ (LLM ì „ì—)

### í™•ì¥ ì•„ì´ë””ì–´
1) **ëŒ€í™” ë¡œê·¸ ê¸°ë°˜ ì „í™˜ ê·¸ë˜í”„ í•™ìŠµ**
2) ì‚¬ìš©ìë³„ â€œì„ í˜¸ í† í”½â€ì„ í´ë¦­/ì²´ë¥˜ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸(ì˜¨ë¼ì¸ ëŸ¬ë‹)
3) LLMì„ â€œë¬¸ì¥ ë‹¤ë“¬ê¸°(rewrite)â€ì—ë§Œ í•œì •í•´ ì•ˆì „ì„±/ì¼ê´€ì„± ê°•í™”
4) í•œêµ­ì–´ ìˆ˜ì¤€ë³„(ì´ˆê¸‰/ì¤‘ê¸‰/ê³ ê¸‰) í…œí”Œë¦¿ ë¶„ë¦¬

### ì‹¤ìˆ˜í•˜ê¸° ì‰¬ìš´ í¬ì¸íŠ¸
- LLMì„ ë¬´ì¡°ê±´ í˜¸ì¶œí•˜ë©´: ë¹„ìš©â†‘, ê²°ê³¼ í”ë“¤ë¦¼â†‘, ë°œí‘œ ë°ëª¨ ë¶ˆì•ˆì •  
- ê·¸ë˜ì„œ ì´ ë…¸íŠ¸ë¶ì²˜ëŸ¼ â€œí…œí”Œë¦¿ ìš°ì„  + ì œí•œì  LLM + ìºì‹œâ€ êµ¬ì¡°ê°€ ì•ˆì „í•©ë‹ˆë‹¤.


print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     Talkativ í† í”½ ì¶”ì²œ ì‹œìŠ¤í…œ (AI-Hub ë°ì´í„° ê¸°ë°˜)               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 ë°ì´í„° ì†ŒìŠ¤:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI-Hub ì£¼ì œë³„ í…ìŠ¤íŠ¸ ì¼ìƒ ëŒ€í™” ë°ì´í„°                                 â”‚
â”‚ - URL: https://aihub.or.kr/aihubdata/data/view.do?dataSetSn=543      â”‚
â”‚ - 10,644ê°œ ëŒ€í™”, 20ê°œ í† í”½                                           â”‚
â”‚ - ì‹¤ì œ ëŒ€í™”ì—ì„œ ì¶”ì¶œí•œ í‚¤ì›Œë“œ ì‚¬ìš©                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 ê°œì„ ëœ ê¸°ëŠ¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. AI-Hub ê¸°ë°˜ í† í”½ ë¶„ë¥˜ (20ê°œ ì¹´í…Œê³ ë¦¬)                              â”‚
â”‚ 2. ê°€ì¤‘ì¹˜ ê¸°ë°˜ í‚¤ì›Œë“œ ë§¤ì¹­ (500+ í‚¤ì›Œë“œ)                              â”‚
â”‚ 3. ì‹œë„ˆì§€ ë³´ë„ˆìŠ¤ (ì—¬ëŸ¬ í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œ ì¶”ê°€ ì ìˆ˜)                       â”‚
â”‚ 4. ê´€ê³„-í† í”½ ì í•©ì„± ë§¤íŠ¸ë¦­ìŠ¤ (4Ã—20)                                   â”‚
â”‚ 5. í† í”½ ì „í™˜ ê·¸ë˜í”„ (ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” íë¦„)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 ì¶”ì²œ ì ìˆ˜ ê³µì‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ score = 0.40 Ã— compatibility + 0.35 Ã— interest + 0.25 Ã— transition   â”‚
â”‚                                                                      â”‚
â”‚ - compatibility: ê´€ê³„ ìœ í˜•ë³„ í† í”½ ì í•©ì„±                              â”‚
â”‚ - interest: ê³µí†µ ê´€ì‹¬ì‚¬ ë§¤ì¹­                                         â”‚
â”‚ - transition: í˜„ì¬ í† í”½ì—ì„œì˜ ìì—°ìŠ¤ëŸ¬ìš´ ì „í™˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")
